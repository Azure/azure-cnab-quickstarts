name: dapr-distributed-calculator
version: 0.1.0
description: A sample dapr application, running a distributed calculator with C#, Go, Node, Python, and React
invocationImage: cnabquickstarts.azurecr.io/porter/dapr-distributed-calculator:0.1.0
tag: cnabquickstarts.azurecr.io/porter/dapr-distributed-calculator/bundle:0.1.0

credentials:
  - name: kubeconfig
    path: /root/.kube/config

parameters:
  - name: namespace
    type: string
    default: dapr-distributed-calculator
    description: Kubernetes namespace for installation
  - name: installation_name
    type: string
    default: dapr-distributed-calculator
    description: Installation name for Helm deployment
    destination:
      env: $INSTALLATION_NAME
  # - name: redis_resource_group
  #   type: string
  #   description: Azure resource group name for Redis instance
  # - name: redis_name
  #   type: string
  #   description: Name for Redis instance
  # - name: redis_name
  #   type: string
  #   description: Name for Redis instance
  # - name: redis_location
  #   type: string
  #   description: Azure location for Redis instance
  # - name: redis_sku
  #   type: string
  #   description: SKU for Redis instance
  #   default: Basic
  #   enum: ["Basic", "Premium", "Standard"]
  # - name: redis_vm_size
  #   type: string
  #   description: VM size for Redis instance
  #   default: c0
  #   enum: ["c0", "c1", "c2", "c3", "c4", "c5", "c6", "p1", "p2", "p3", "p4", "p5"]


outputs:
  - name: ip
    type: string
    sensitive: false
    applyTo:
      - install
      - upgrade
    description: "External IP address for the calculator front-end"

mixins:
  - exec
  - helm3
  - kubernetes
  - az

install:
  # - az: 
  #     description: "Create Azure Redis instance"
  #     arguments: 
  #       - "redis" 
  #       - "create" 
  #     flags:
  #       resource-group: "{{ bundle.parameters.redis_resource_group }}"
  #       name: "{{ bundle.parameters.redis_name }}"
  #       location: "{{ bundle.parameters.redis_location }}"
  #       sku: "{{ bundle.parameters.redis_sku }}"
  #       vm-size: "{{ bundle.parameters.redis_vm_size }}"
  # - az: 
  #     description: "Create Azure Redis instance"
  #     arguments: 
  #       - "redis" 
  #       - "list-keys" 
  #     flags:
  #       resource-group: "{{ bundle.parameters.redis_resource_group }}"
  #       name: "{{ bundle.parameters.redis_name }}"

  - exec:
      description: Create Kubernetes namespace
      command: bash
      arguments:
        - "scripts/dapr-calculator.sh"
        - "create-namespace"
        - "{{ bundle.parameters.namespace }}"
  - helm3:
      description: "Install Dapr distributed calculator"
      arguments: 
        - install
        - "{{ bundle.parameters.installation_name }}"
        - ./helm/dapr-distributed-calculator
      flags:
        namespace: "{{ bundle.parameters.namespace }}"
        replace:
        set:
          - "dotnetSubtractor.image.repository={{ bundle.images.dotnetSubtractor.repository }}"
          - "dotnetSubtractor.image.tag={{ bundle.images.dotnetSubtractor.tag }}"
          - "goAdder.image.repository={{ bundle.images.goAdder.repository }}"
          - "goAdder.image.tag={{ bundle.images.goAdder.tag }}"
          - "nodeDivider.image.repository={{ bundle.images.nodeDivider.repository }}"
          - "nodeDivider.image.tag={{ bundle.images.nodeDivider.tag }}"
          - "pythonMultiplier.image.repository={{ bundle.images.pythonMultiplier.repository }}"
          - "pythonMultiplier.image.tag={{ bundle.images.pythonMultiplier.tag }}"
          - "reactCalculator.image.repository={{ bundle.images.reactCalculator.repository }}"
          - "reactCalculator.image.tag={{ bundle.images.reactCalculator.tag }}"
          # - "redis.host={{ bundle.parameters.redis_host }}"
          # - "redis.password={{ bundle.outputs.redis_password }}"
          - "redis.host=redishost"
          - "redis.password=redispassword"
  - exec:
      description: "Get IP address"
      command: "bash"
      arguments:
        - "scripts/get-ip-address.sh"
        - "{{ bundle.parameters.namespace }}"
      outputs:
        - name: ip
          path: IP

upgrade:
  - helm3:
      description: "Upgrade Dapr distributed calculator"
      arguments: 
        - upgrade
        - "{{ bundle.parameters.installation_name }}"
        - ./helm/dapr-distributed-calculator
      flags:
        namespace: "{{ bundle.parameters.namespace }}"
        set:
          - "dotnetSubtractor.image.repository={{ bundle.images.dotnetSubtractor.repository }}"
          - "dotnetSubtractor.image.tag={{ bundle.images.dotnetSubtractor.tag }}"
          - "goAdder.image.repository={{ bundle.images.goAdder.repository }}"
          - "goAdder.image.tag={{ bundle.images.goAdder.tag }}"
          - "nodeDivider.image.repository={{ bundle.images.nodeDivider.repository }}"
          - "nodeDivider.image.tag={{ bundle.images.nodeDivider.tag }}"
          - "pythonMultiplier.image.repository={{ bundle.images.pythonMultiplier.repository }}"
          - "pythonMultiplier.image.tag={{ bundle.images.pythonMultiplier.tag }}"
          - "reactCalculator.image.repository={{ bundle.images.reactCalculator.repository }}"
          - "reactCalculator.image.tag={{ bundle.images.reactCalculator.tag }}"
          # - "redis.host={{ bundle.parameters.redis_host }}"
          # - "redis.password={{ bundle.outputs.redis_password }}"
          - "redis.host=redishost"
          - "redis.password=redispassword"
  - exec:
      description: "Get IP address"
      command: "bash"
      arguments:
        - "scripts/get-ip-address.sh"
        - "{{ bundle.parameters.namespace }}"
      outputs:
        - name: ip
          path: IP

uninstall:
  - helm3:
      description: "Uninstall Dapr distributed calculator"
      arguments:
        - "uninstall"
        - "{{ bundle.parameters.installation_name }}"
      flags:
        namespace: "{{ bundle.parameters.namespace }}"
  - exec:
      description: Delete Kubernetes namespace
      command: bash
      arguments:
        - "scripts/dapr-calculator.sh"
        - "delete-namespace"
        - "{{ bundle.parameters.namespace }}"
      
images:
  dotnetSubtractor:
    description: dotnetSubtractor
    imageType: docker
    repository: cnabquickstarts.azurecr.io/dapr-distributed-calculator/csharp
    tag: 0.5.0
  goAdder:
    description: goAdder
    imageType: docker
    repository: cnabquickstarts.azurecr.io/dapr-distributed-calculator/go
    tag: 0.5.0
  nodeDivider:
    description: nodeDivider
    imageType: docker
    repository: cnabquickstarts.azurecr.io/dapr-distributed-calculator/node
    tag: 0.5.0
  pythonMultiplier:
    description: pythonMultiplier
    imageType: docker
    repository: cnabquickstarts.azurecr.io/dapr-distributed-calculator/python
    tag: 0.5.0
  reactCalculator:
    description: reactCalculator
    imageType: docker
    repository: cnabquickstarts.azurecr.io/dapr-distributed-calculator/react-calculator
    tag: 0.5.0