name: dapr
version: 0.1.0
dockerfile: Dockerfile.tmpl
description: Installs Dapr on a Kubernetes cluster, using the official Dapr Helm chart
invocationImage: cnabquickstarts.azurecr.io/porter/dapr:0.1.0
tag: cnabquickstarts.azurecr.io/porter/dapr/bundle:0.1.0

credentials:
  - name: kubeconfig
    path: /root/.kube/config

parameters:
  - name: namespace
    type: string
    default: dapr-system
    description: Kubernetes namespace for installation
  - name: installation_name
    type: string
    default: dapr
    description: Installation name for Helm deployment
    destination:
      env: $INSTALLATION_NAME
  - name: helm_chart_version
    type: string
    default: 0.1.0
    description: Version of the dapr/dapr Helm chart to use for deployment
  - name: global_repository
    type: string
    description: Container image repository
    default: 'docker.io/daprio'
    destination:
      env: GLOBAL_REPOSITORY
  - name: global_tag
    type: string
    description: Container image tag
    default: '0.5.0'
    destination:
      env: GLOBAL_TAG
  - name: global_imagePullPolicy
    type: string
    description: Container image pull policy
    default: 'Always'
    destination:
      env: GLOBAL_IMAGEPULLPOLICY


mixins:
  - exec
  - helm3
  - kubernetes

install:
  - exec:
      description: "Replace tokens in values.yaml.template"
      command: "bash"
      arguments: 
        - "dapr.sh" 
        - "replace-tokens"
  - exec:
      description: Create Kubernetes namespace
      command: bash
      arguments:
        - "dapr.sh" 
        - "create-kubernetes-namespace"
        - "{{ bundle.parameters.namespace }}"
  - helm3:
      description: "Add dapr Helm repository"
      arguments:
        - "repo"
        - "add"
        - "dapr"
        - "https://daprio.azurecr.io/helm/v1/repo"
  - helm3:
      description: "Update Helm repositories"
      arguments:
        - "repo"
        - "update"
  - helm3:
      description: "Install Dapr"
      arguments:
        - "install"
        - "{{ bundle.parameters.installation_name }}"
        - dapr/dapr
      flags:
        namespace: "{{ bundle.parameters.namespace }}"
        replace:
        values:
          - /cnab/app/values.yaml

upgrade:
  - exec:
      description: "Replace tokens in values.yaml.template"
      command: "bash"
      arguments: 
        - "dapr.sh" 
        - "replace-tokens"
  - helm3:
      description: "Add dapr Helm repository"
      arguments:
        - "repo"
        - "add"
        - "dapr"
        - "https://daprio.azurecr.io/helm/v1/repo"
  - helm3:
      description: "Update Helm repositories"
      arguments:
        - "repo"
        - "update"
  - helm3:
      description: "Upgrade Dapr"
      arguments:
        - "upgrade"
        - "{{ bundle.parameters.installation_name }}"
        - dapr/dapr
      flags:
        namespace: "{{ bundle.parameters.namespace }}"
        values:
          - /cnab/app/values.yaml
     
uninstall:
  - helm3:
      description: "Uninstall Dapr"
      arguments:
        - "uninstall"
        - "{{ bundle.parameters.installation_name }}"
      flags:
        namespace: "{{ bundle.parameters.namespace }}"
  - exec:
      description: Delete Kubernetes namespace
      command: bash
      arguments:
        - "dapr.sh" 
        - "delete-kubernetes-namespace"
        - "{{ bundle.parameters.namespace }}"